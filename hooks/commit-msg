#!/bin/sh
# ==========================
# PIXELCORE COMMIT HOOK (DRY)
# ==========================
# Enforces commit message prefixes using a dictionary

# --------- DEFINE PREFIXES ---------
# Format: prefix="description"
declare -A PREFIXES
PREFIXES=(
  [feat]="new feature"
  [fix]="bug fix"
  [docs]="documentation"
  [test]="tests"
  [chore]="maintenance tasks"
  [refactor]="refactoring code"
  [hotfix]="urgent production fix"
  [ci]="CI/CD workflow changes"
  [perf]="performance improvement"
  [build]="build system changes"
)

# --------- CREATE REGEX FROM PREFIXES ---------
prefix_regex=$(IFS='|'; echo "^( ${!PREFIXES[*]} ): .+" | sed 's/ /|/g')

# Read commit message
commit_msg=$(cat "$1" | tr -d '\n')

# --------- CHECK EMPTY COMMIT ---------
if [ -z "$commit_msg" ]; then
  echo "ERROR: Commit message cannot be empty!"
  exit 1
fi

# --------- CHECK PREFIX ---------
if ! echo "$commit_msg" | grep -qE "$prefix_regex"; then
  echo "================ COMMIT MESSAGE ERROR ================"
  echo "Your commit message must start with one of these prefixes:"
  for key in "${!PREFIXES[@]}"; do
    echo "  $key: ${PREFIXES[$key]}"
  done
  echo ""
  echo "Correct examples:"
  for key in "${!PREFIXES[@]}"; do
    echo "  $key: Example description for ${PREFIXES[$key]}"
  done
  echo "======================================================"
  exit 1
fi

# --------- OPTIONAL WARNING: capitalize first letter ---------
first_char=$(echo "$commit_msg" | sed -E 's/^[a-z]+: ([A-Za-z]).*/\1/')
if [[ "$first_char" =~ [a-z] ]]; then
  echo "WARNING: Capitalize first letter of commit description after prefix."
fi

# --------- PASSED ---------
exit 0
